 Conte√∫do de firestore.rules ---
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regras para a cole√ß√£o 'anuncios'
    match /anuncios/{anuncioId} {
      // Permitir leitura p√∫blica (todos podem ler)
      allow read: if true;
      ---
      // Permitir escrita apenas para usu√°rios autenticados
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Regras para a cole√ß√£o 'advertisements'
    match /advertisements/{advertisementId} {
      // Permitir leitura p√∫blica (todos podem ler)
      allow read: if true;
      
      // Permitir escrita apenas para usu√°rios autenticados
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Regras para outras cole√ß√µes (users, payments, etc.)
    match /users/{userId} {
      // Usu√°rios podem ler apenas seus pr√≥prios dados
      allow read: if request.auth != null && request.auth.uid == userId;
      // Usu√°rios podem criar/atualizar apenas seus pr√≥prios dados
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false; // N√£o permitir exclus√£o de usu√°rios
    }
    
    match /payments/{paymentId} {
      // Apenas usu√°rios autenticados podem ler seus pr√≥prios pagamentos
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
      allow update, delete: if false; // Pagamentos n√£o podem ser modificados
    }
    
    // Regra padr√£o: negar acesso a todas as outras cole√ß√µes
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

--- Configura√ß√£o Firebase (frontend/src/firebase-config.js) ---
// Firebase Configuration
// Substitua os valores abaixo pelas suas configura√ß√µes do Firebase

const firebaseConfig = {
  apiKey: "AIzaSyCCU3l-J-7JrlWXKVlQJAit9VypIi7hn38",
  authDomain: "mansao-do-job.firebaseapp.com",
  projectId: "mansao-do-job",
  storageBucket: "mansao-do-job.firebasestorage.app",
  messagingSenderId: "606628146135",
  appId: "1:606628146135:web:b374ed2678d20991577992",
  measurementId: "G-4EZJTTZNC4",
};

// Exportar configura√ß√£o
if (typeof module !== "undefined" && module.exports) {
  module.exports = firebaseConfig;
} else {
  window.firebaseConfig = firebaseConfig;
}

--- Modelo de dados Anuncio (frontend/src/modelo-cadastro-anuncios.html) ---
const anuncioData = {
  // Dados b√°sicos
  nome: formData.get('nome'),
  idade: formData.get('idade'),
  telefone_celular: formData.get('telefone_celular'),
  telefone_fixo: formData.get('telefone_fixo'),
  email: formData.get('email'),
  descricao: formData.get('descricao'),
  'frase-efeito': formData.get('frase-efeito'),
  frase_efeito: formData.get('frase-efeito'), // Tamb√©m salvar com underscore para compatibilidade
  
  // Servi√ßos obrigat√≥rios - CORRIGIDO: pegar apenas se marcado, salvar como "sim" em vez de "on"
  // IMPORTANTE: Estes campos s√£o SEPARADOS dos checkboxes de servi√ßos
  // Eles s√£o campos booleanos individuais que tamb√©m podem ser marcados separadamente
  'oral-sem': document.querySelector('input[name="oral-sem"]:checked') ? 'sim' : null,
  oral_sem: document.querySelector('input[name="oral-sem"]:checked') ? 'sim' : null,
  beija: document.querySelector('input[name="beija"]:checked') ? 'sim' : null,
  anal: document.querySelector('input[name="anal"]:checked') ? 'sim' : null,
  'mora-so': document.querySelector('input[name="mora-so"]:checked') ? 'sim' : null,
  mora_so: document.querySelector('input[name="mora-so"]:checked') ? 'sim' : null,
  
  // Atende (array de checkboxes) - usar valores j√° calculados e validados
  atende: atendeValues,
  
  // Eu Fa√ßo (array de checkboxes) - usar fun√ß√£o padr√£o
  'eu-faco': capturarCheckboxesValidados('eu-faco', true),
  eu_faco: capturarCheckboxesValidados('eu-faco', true), // Vers√£o com underscore
  
  // Pubis (array de checkboxes) - usar fun√ß√£o padr√£o
  pubis: capturarCheckboxesValidados('pubis', true),
  
  // Aceita WhatsApp e Liga√ß√£o (campos booleanos √∫nicos, n√£o arrays)
  aceita_whatsapp: document.querySelector('input[name="aceita_whatsapp"]:checked') ? true : false,
  aceita_ligacao: document.querySelector('input[name="aceita_ligacao"]:checked') ? true : false,
  
  // Servi√ßos organizados por categoria - APENAS ESTES SER√ÉO SALVOS
  servicos_basicos: servicosBasicos,
  servicos_especiais: servicosEspeciais,
  fetichismo_bdsm: fetichismoBdsm,
  atendimento_grupo: atendimentoGrupo,
  perfil_estilo: perfilEstilo,
  servicos_extras: servicosExtras,
  
  // CAMPOS REMOVIDOS (n√£o ser√£o mais salvos):
  // servicos - REMOVIDO
  // servicos_oferecidos - REMOVIDO
  // servicos_total - REMOVIDO
  // servicos_categorias_preenchidas - REMOVIDO
  
  // Localiza√ß√£o
  estado: formData.get('estado'),
  cidade: formData.get('cidade'),
  bairro: formData.get('bairro'),
  
  // Local (Com Local / Sem Local)
  local: formData.get('local') || document.querySelector('input[name="local"]:checked')?.value || null,
  
  // Categoria e g√™nero
  genero: gender,
  categoria: category,
  // Compatibilidade: tamb√©m salvar como 'category' e 'gender'
  category: category, // Para compatibilidade com filtros
  gender: gender, // Para compatibilidade com filtros
  
  // Dados f√≠sicos
  corpo: formData.get('corpo'),
  estatura: formData.get('estatura'),
  altura: formData.get('altura'),
  peso: formData.get('peso'),
  
  // Pre√ßos
  preco_30min: formData.get('preco_30min'),
  preco_1h: formData.get('preco_1h'),
  preco_2h: formData.get('preco_2h'),
  
  // Timestamp
  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  userId: activeUser.uid,
  userEmail: activeUser.email
};

--- Persist√™ncia e p√≥s-processamento do cadastro (frontend/src/modelo-cadastro-anuncios.html) ---
const docRef = await db.collection("anuncios").add(anuncioDataParaSalvar);
console.log("\n‚úÖ An√∫ncio salvo com ID:", docRef.id);
console.log("‚úÖ Todos os arrays de servi√ßos foram salvos no Firebase!");

// Verificar ap√≥s salvar se os campos foram realmente salvos
await new Promise(resolve => setTimeout(resolve, 1000)); // Aguardar 1 segundo
const docSalvo = await db.collection("anuncios").doc(docRef.id).get();
if (docSalvo.exists) {
  const dadosSalvos = docSalvo.data();
  console.log("\nüîç Verifica√ß√£o ap√≥s salvar - Campos no Firebase:");
  console.log("  - servicos_basicos:", dadosSalvos.servicos_basicos);
  console.log("  - servicos_especiais:", dadosSalvos.servicos_especiais);
  console.log("  - fetichismo_bdsm:", dadosSalvos.fetichismo_bdsm);
  console.log("  - atendimento_grupo:", dadosSalvos.atendimento_grupo);
  console.log("  - perfil_estilo:", dadosSalvos.perfil_estilo);
  console.log("  - servicos_extras:", dadosSalvos.servicos_extras);
  
  // Se algum array n√£o foi salvo, for√ßar atualiza√ß√£o
  const precisaAtualizar = !dadosSalvos.fetichismo_bdsm || !dadosSalvos.atendimento_grupo || !dadosSalvos.perfil_estilo;
  if (precisaAtualizar) {
    console.warn("‚ö†Ô∏è Alguns arrays n√£o foram salvos, for√ßando atualiza√ß√£o...");
    await db.collection("anuncios").doc(docRef.id).update({
      fetichismo_bdsm: anuncioDataParaSalvar.fetichismo_bdsm,
      atendimento_grupo: anuncioDataParaSalvar.atendimento_grupo,
      perfil_estilo: anuncioDataParaSalvar.perfil_estilo
    });
    console.log("‚úÖ Arrays faltantes foram atualizados!");
  }
}

--- Classe ProtecaoDuplicatas (frontend/src/protecao-duplicatas.js) ---
if (anuncioExistente) {
  // Atualizar an√∫ncio existente
  console.log('üîÑ Atualizando an√∫ncio existente...');
  const resultado = await this.atualizarAnuncio(anuncioExistente.id, dados);
  
  return {
    sucesso: true,
    acao: 'ATUALIZADO',
    mensagem: 'An√∫ncio atualizado com sucesso!',
    documentoId: anuncioExistente.id
  };
} else {
  // Criar novo an√∫ncio
  console.log('‚ú® Criando novo an√∫ncio...');
  const resultado = await this.criarAnuncio(dados);
  
  return {
    sucesso: true,
    acao: 'CRIADO',
    mensagem: 'An√∫ncio criado com sucesso!',
    documentoId: resultado.id
  };
}

async verificarAnuncioExistente(email, userId) {
  try {
    // Buscar por email
    const emailQuery = await db.collection('anuncios')
      .where('email', '==', email)
      .limit(1)
      .get();
    
    if (!emailQuery.empty) {
      const doc = emailQuery.docs[0];
      return { id: doc.id, ...doc.data() };
    }
    
    // Buscar por userId
    const userIdQuery = await db.collection('anuncios')
      .where('userId', '==', userId)
      .limit(1)
      .get();
    
    if (!userIdQuery.empty) {
      const doc = userIdQuery.docs[0];
      return { id: doc.id, ...doc.data() };
    }
    
    return null;
    
  } catch (error) {
    console.error('‚ùå Erro ao verificar an√∫ncio existente:', error);
    return null;
  }
}

async atualizarAnuncio(documentoId, dados) {
  try {
    const dadosAtualizados = {
      ...dados,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      versao: firebase.firestore.FieldValue.increment(1)
    };
    
    await db.collection('anuncios').doc(documentoId).update(dadosAtualizados);
    
    return { sucesso: true };
    
  } catch (error) {
    console.error('‚ùå Erro ao atualizar an√∫ncio:', error);
    throw error;
  }
}

async criarAnuncio(dados) {
  try {
    const dadosCompletos = {
      ...dados,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      versao: 1
    };
    
    const docRef = await db.collection('anuncios').add(dadosCompletos);
    
    return { id: docRef.id, sucesso: true };
    
  } catch (error) {
    console.error('‚ùå Erro ao criar an√∫ncio:', error);
    throw error;
  }
}

--- Carregamento de an√∫ncios no frontend (frontend/src/js/anuncios.js) ---
async loadAnuncios() {
  try {
    this.showLoading(true);

    console.log("üì° Carregando an√∫ncios do Firebase...");

    // Buscar an√∫ncios aprovados e publicados
    const snapshot = await this.db
      .collection("advertisements")
      .where("status", "==", "published")
      .orderBy("publishedAt", "desc")
      .get();

    this.anuncios = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      this.anuncios.push({
        id: doc.id,
        ...data,
        // Adicionar dados do usu√°rio se dispon√≠vel
        userData: data.userId ? { id: data.userId } : null,
      });
    });

    console.log(`‚úÖ ${this.anuncios.length} an√∫ncios carregados`);

    // Atualizar estat√≠sticas
    this.updateStats();
  } catch (error) {
    console.error("‚ùå Erro ao carregar an√∫ncios:", error);
    this.showError("Erro ao carregar an√∫ncios. Tente novamente.");
  } finally {
    this.showLoading(false);
  }
}

--- Inicializa√ß√£o Firebase Admin (backend/server.js) ---
import express from "express";
import cors from "cors";
import admin from "firebase-admin";
import dotenv from "dotenv";

dotenv.config({ path: './config-firebase-only.env' });

const app = express();

// Middleware CORS UNIFICADO
app.use(cors({
  origin: [
    "http://localhost:8080",
    "http://127.0.0.1:8080",
    "http://localhost:5500",
    "http://127.0.0.1:5500"
  ],
  credentials: true
}));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Log de inicializa√ß√£o
console.log("üöÄ Iniciando servidor UNIFICADO...");
console.log(`üìä Projeto: ${process.env.PROJECT_NAME || 'copia-do-job'}`);
console.log(`üåç Ambiente: ${process.env.ENVIRONMENT || 'test'}`);
console.log(`üîó Porta: ${process.env.PORT || 5001}`);
console.log(`üî• Firebase: ${process.env.FIREBASE_PROJECT_ID}`);

// Inicializar Firebase Admin SDK
const serviceAccount = {
  type: "service_account",
  project_id: process.env.FIREBASE_PROJECT_ID,
  private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
  private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
  client_email: process.env.FIREBASE_CLIENT_EMAIL,
  client_id: process.env.FIREBASE_CLIENT_ID,
  auth_uri: "https://accounts.google.com/o/oauth2/auth",
  token_uri: "https://oauth2.googleapis.com/token",
  auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
  client_x509_cert_url: `https://www.googleapis.com/robot/v1/metadata/x509/${encodeURIComponent(process.env.FIREBASE_CLIENT_EMAIL)}`
};

try {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    projectId: process.env.FIREBASE_PROJECT_ID,
    storageBucket: `${process.env.FIREBASE_PROJECT_ID}.firebasestorage.app`
  });
  
  console.log("‚úÖ Firebase Admin SDK inicializado com sucesso");
  console.log(`üì¶ Storage Bucket: ${process.env.FIREBASE_PROJECT_ID}.firebasestorage.app`);
} catch (error) {
  console.error("‚ùå Erro ao inicializar Firebase:", error.message);
  process.exit(1);
}

const db = admin.firestore();
const bucket = admin.storage().bucket();

--- Rotas CRUD conectadas ao Firestore (backend/server.js) ---
app.get("/api/anuncios", async (req, res) => {
  try {
    const { categoria, status, limit } = req.query;
    let query = db.collection('anuncios');
    
    if (categoria) {
      query = query.where('categoria', '==', categoria);
    }
    
    if (status) {
      query = query.where('status', '==', status);
    }
    
    if (limit) {
      query = query.limit(parseInt(limit));
    }
    
    const snapshot = await query.get();
    const anuncios = [];
    
    for (const doc of snapshot.docs) {
      const data = doc.data();
      const anuncio = {
        id: doc.id,
        ...data,
        foto_capa: await getImageUrl(data.foto_capa),
        coverImage: data.coverImage,
        foto_stories: data.foto_stories,
        profileImage: data.profileImage,
        galeria_1: data.galeria_1,
        galeria_2: data.galeria_2,
        galeria_3: data.galeria_3,
        galeria_4: data.galeria_4,
        galeria_5: data.galeria_5,
        galeria_6: data.galeria_6,
        images: data.images || []
      };
      anuncios.push(anuncio);
    }
    
    res.json(anuncios);
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

app.get("/api/anuncios/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const doc = await db.collection('anuncios').doc(id).get();
    
    if (!doc.exists) {
      return res.status(404).json({ success: false, error: "An√∫ncio n√£o encontrado" });
    }
    
    const data = doc.data();
    const anuncio = {
      id: doc.id,
      ...data,
      foto_capa: await getImageUrl(data.foto_capa),
      coverImage: await getImageUrl(data.coverImage),
      foto_stories: await getImageUrl(data.foto_stories),
      profileImage: await getImageUrl(data.profileImage),
      galeria_1: await getImageUrl(data.galeria_1),
      galeria_2: await getImageUrl(data.galeria_2),
      galeria_3: await getImageUrl(data.galeria_3),
      galeria_4: await getImageUrl(data.galeria_4),
      galeria_5: await getImageUrl(data.galeria_5),
      galeria_6: await getImageUrl(data.galeria_6),
      images: data.images || []
    };
    
    res.json({ success: true, data: anuncio });
  } catch (error) {
    res.status(500).json({ success: false, error: "Erro interno do servidor" });
  }
});

app.post("/api/anuncios", async (req, res) => {
  try {
    const anuncioData = {
      ...req.body,
      environment: process.env.ENVIRONMENT || "test",
      project: process.env.PROJECT_NAME || "copia-do-job",
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    };
    
    const docRef = await db.collection('anuncios').add(anuncioData);
    
    res.status(201).json({
      success: true,
      message: "An√∫ncio criado com sucesso no Firebase",
      id: docRef.id,
      data: anuncioData
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

app.put("/api/anuncios/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const updateData = {
      ...req.body,
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('anuncios').doc(id).update(updateData);
    
    const updatedDoc = await db.collection('anuncios').doc(id).get();
    
    res.json({
      success: true,
      data: {
        id: updatedDoc.id,
        ...updatedDoc.data()
      }
    });
  } catch (error) {
    res.status(500).json({ 
      success: false,
      error: "Erro interno do servidor"
    });
  }
});

app.delete("/api/anuncios/:id", async (req, res) => {
  try {
    const { id } = req.params;
    await db.collection('anuncios').doc(id).delete();
    
    res.json({ 
      success: true,
      message: "An√∫ncio deletado com sucesso"
    });
  } catch (error) {
    res.status(500).json({ 
      success: false,
      error: "Erro interno do servidor"
    });
  }
});















